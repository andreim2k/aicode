#!/bin/bash

set -euo pipefail

# Restore cursor and exit on interrupt
trap 'printf "\033[?25h"; exit 0' INT TERM EXIT

# Check if claude is installed
if ! command -v claude &> /dev/null; then
    echo "Error: claude command is not installed. Please install it first."
    echo "Visit: https://github.com/anthropics/claude-cli"
    exit 1
fi

# Paths
CONFIG_DIR="${HOME}/.config/aicode"
SETTINGS_FILE="${CONFIG_DIR}/settings.json"
CLAUDE_CONFIG_DIR="${HOME}/.claude"
CLAUDE_CONFIG_FILE="${CLAUDE_CONFIG_DIR}/settings.json"

# Create config directory if it doesn't exist
mkdir -p "${CONFIG_DIR}"
mkdir -p "${CLAUDE_CONFIG_DIR}"

# Check if settings.json exists
if [ ! -f "${SETTINGS_FILE}" ]; then
    echo "Error: Settings file not found at ${SETTINGS_FILE}"
    echo "Please create this file with your provider configurations."
    exit 1
fi

# Function to validate JSON
validate_json() {
    if ! jq empty "$1" 2>/dev/null; then
        echo "Error: Invalid JSON in $1"
        exit 1
    fi
}

validate_json "${SETTINGS_FILE}"

# Function to fetch models from provider API
fetch_models_from_api() {
    local base_url="$1"
    local auth_token="$2"

    # Try to fetch models from /models endpoint
    local models=$(curl -s -H "Authorization: Bearer ${auth_token}" \
        "${base_url%/}/models" 2>/dev/null | jq -r '.data[].id' 2>/dev/null)

    if [ -z "$models" ]; then
        # Fallback: return empty if fetch fails
        echo ""
    else
        echo "$models"
    fi
}

# Function to get models for a provider (from settings.json or fetch from API)
get_models_for_provider() {
    local provider="$1"
    local base_url="$2"
    local auth_token="$3"

    # Check if models are in settings.json
    local settings_models=$(jq -r ".[] | select(.provider == \"${provider}\") | .models[]?" "${SETTINGS_FILE}" 2>/dev/null)

    if [ -n "$settings_models" ]; then
        # Filter and sort: exclude models with two slashes, then sort ascending (case-insensitive)
        echo "$settings_models" | grep -v '/.*/' | sort -f
        return
    fi

    # If no models in settings, fetch from API and filter
    fetch_models_from_api "$base_url" "$auth_token" | grep -v '/.*/' | sort -f
}

# Function to add model to recent cache (keep last 5) in settings.json
cache_recent_model() {
    local provider="$1"
    local model="$2"

    # Create a temporary JSON array with the new model list
    local models_array=$(echo "$model" | jq -R . | jq -s .)

    # Update settings.json: add model to front of models array for this provider, keep max 5
    local settings_data=$(cat "${SETTINGS_FILE}")

    settings_data=$(echo "$settings_data" | jq --arg provider "$provider" --arg model "$model" \
        '(.[] | select(.provider == $provider) | .models) |= [($model)] + (. - [$model]) | .[].models |= .[0:5]' 2>/dev/null)

    if [ -n "$settings_data" ] && [ "$settings_data" != "null" ]; then
        echo "$settings_data" > "${SETTINGS_FILE}"
    fi
}

# Function to create claude config
create_claude_config() {
    local base_url="$1"
    local auth_token="$2"
    local model="$3"
    
    cat > "${CLAUDE_CONFIG_FILE}" << EOF
{
    "env": {
        "ANTHROPIC_BASE_URL": "${base_url}",
        "ANTHROPIC_AUTH_TOKEN": "${auth_token}",
        "ANTHROPIC_MODEL": "${model}"
    }
}
EOF
}

# Function to extract provider data
get_provider_data() {
    local provider_name="$1"
    jq -r ".[] | select(.provider == \"${provider_name}\") | \"\(.base_url)|\(.auth_token)|\(.model)\"" "${SETTINGS_FILE}"
}

# Display menu and get selection with interactive UI
show_menu() {
    local providers_array=()
    local options=()
    
    # Add Claude as first option
    options+=("claude")
    
    # Parse providers from settings.json
    while IFS= read -r line; do
        if [ -n "$line" ]; then
            providers_array+=("$line")
            local provider_name=$(echo "$line" | jq -r '.provider')
            options+=("$provider_name")
        fi
    done < <(jq -c '.[]' "${SETTINGS_FILE}")
    
    # Show provider selection menu
    show_provider_menu
    return
}

# Hierarchical provider/model selection menu
show_provider_menu() {
    local providers_array=()
    local menu_items=()
    local menu_types=()
    local menu_parents=()
    local selected_index=0
    local expanded_provider=""

    # Add Claude as first option
    menu_items+=("claude")
    menu_types+=("provider")
    menu_parents+=("")

    # Parse providers from settings.json
    while IFS= read -r line; do
        if [ -n "$line" ]; then
            providers_array+=("$line")
            local provider_name=$(echo "$line" | jq -r '.provider')
            menu_items+=("$provider_name")
            menu_types+=("provider")
            menu_parents+=("")
        fi
    done < <(jq -c '.[]' "${SETTINGS_FILE}")
    
    printf "[1;37mSelect AI Provider and Model:[0m\n"
    
    local last_lines=0
    
    # Draw menu
    draw_menu() {
        local i=0
        local display_index=0
        local lines_count=0
        local max_window=10
        local window_start=0

        # Calculate window start to keep selected item visible
        if [ $selected_index -ge $max_window ]; then
            window_start=$((selected_index - max_window + 1))
        fi

        for item in "${menu_items[@]}"; do
            local item_type="${menu_types[$i]}"
            local item_parent="${menu_parents[$i]}"

            # Only display items within the window
            if [ $i -ge $window_start ] && [ $lines_count -lt $max_window ]; then
                if [ $i -eq $selected_index ]; then
                    if [ "$item_parent" == "" ]; then
                        printf "\033[1;32m>\033[0m \033[1;36m%s\033[0m\n" "$item"
                    else
                        # Check if it's a recent model
                        if [ "$item_type" == "model_recent" ]; then
                            printf "\033[1;32m>\033[0m   \033[1;33m%s\033[0m \033[1;32m(recent)\033[0m\n" "$item"
                        else
                            printf "\033[1;32m>\033[0m   \033[1;33m%-s\033[0m\n" "$item"
                        fi
                    fi
                else
                    if [ "$item_parent" == "" ]; then
                        printf "  \033[38;5;246m%s\033[0m\n" "$item"
                    else
                        # Check if it's a recent model
                        if [ "$item_type" == "model_recent" ]; then
                            printf "    \033[38;5;246mâ”œâ”€ %s\033[0m \033[1;32m(recent)\033[0m\n" "$item"
                        else
                            printf "    \033[38;5;246mâ”œâ”€ %s\033[0m\n" "$item"
                        fi
                    fi
                fi
                ((lines_count++))
            fi
            ((i++))
        done
        last_lines=$lines_count
    }
    
    draw_menu

    # Hide cursor during menu selection
    printf "\033[?25l"

    # Read arrow keys and Enter
    while IFS= read -rsn1 key; do
        if [[ $key == $'\x1b' ]]; then
            read -rsn2 key
            if [[ $key == '[A' ]]; then
                ((selected_index--))
                if [ $selected_index -lt 0 ]; then
                    selected_index=$((${#menu_items[@]} - 1))
                fi
                printf "\033[${last_lines}A\033[J"
                draw_menu
            elif [[ $key == '[B' ]]; then
                ((selected_index++))
                if [ $selected_index -ge ${#menu_items[@]} ]; then
                    selected_index=0
                fi
                printf "\033[${last_lines}A\033[J"
                draw_menu
            fi
        elif [[ $key == '' ]]; then
            # Enter key pressed
            local selected_item="${menu_items[$selected_index]}"
            local selected_type="${menu_types[$selected_index]}"
            local selected_parent="${menu_parents[$selected_index]}"
            
            # If selecting a model (has parent)
            if [ "$selected_parent" != "" ]; then
                SELECTED_PROVIDER="$selected_parent"
                # Strip star if present (from recent models)
                SELECTED_MODEL="$selected_item"
                SELECTED_MODEL="${SELECTED_MODEL#â˜… }"  # Remove leading star and space
                selected_provider_data=$(jq -c ".[] | select(.provider == \"$SELECTED_PROVIDER\")" "${SETTINGS_FILE}")
                # Cache this model as recently used
                cache_recent_model "$SELECTED_PROVIDER" "$SELECTED_MODEL"
                apply_provider_config
                break
            fi
            
            # If selecting Claude
            if [ "$selected_item" == "claude" ]; then
                if [ -f "${CLAUDE_CONFIG_FILE}" ]; then
                    rm "${CLAUDE_CONFIG_FILE}"
                fi
                unset ANTHROPIC_BASE_URL ANTHROPIC_AUTH_TOKEN ANTHROPIC_MODEL 2>/dev/null
                echo -e "\n\033[1;32mUsing provider:\033[0m \033[1;36m${selected_item}\033[0m"
                echo -e "\033[38;5;246mInitializing Claude (this may take a moment)...\033[0m"
                break
            fi
            
            # If provider is already expanded, collapse it
            if [ "$expanded_provider" == "$selected_item" ]; then
                expanded_provider=""
                # Remove models from menu
                local new_items=()
                local new_types=()
                local new_parents=()
                for j in "${!menu_items[@]}"; do
                    if [ "${menu_parents[$j]}" != "$selected_item" ]; then
                        new_items+=("${menu_items[$j]}")
                        new_types+=("${menu_types[$j]}")
                        new_parents+=("${menu_parents[$j]}")
                    fi
                done
                menu_items=("${new_items[@]}")
                menu_types=("${new_types[@]}")
                menu_parents=("${new_parents[@]}")
                if [ $selected_index -ge ${#menu_items[@]} ]; then
                    selected_index=$((${#menu_items[@]} - 1))
                fi
            else
                # Expand provider - add models (always fetch from API)
                local provider_data=$(jq -c ".[] | select(.provider == \"$selected_item\")" "${SETTINGS_FILE}")
                local base_url=$(echo "$provider_data" | jq -r '.base_url')
                local auth_token=$(echo "$provider_data" | jq -r '.auth_token')
                local models=()
                local cached_models=()

                # ALWAYS fetch all models from API (don't use settings.json models list)
                # NOTE: Using sort -f for case-insensitive sorting but preserving original case
                local api_models=$(fetch_models_from_api "$base_url" "$auth_token" 2>/dev/null | grep -v '/.*/' | sort -f)
                while IFS= read -r model; do
                    if [ -n "$model" ]; then
                        models+=("$model")
                    fi
                done <<< "$api_models"

                # Get cached/recent models for this provider from settings.json to display first
                local cached_list=$(jq -r ".[] | select(.provider == \"${selected_item}\") | .models[]?" "${SETTINGS_FILE}" 2>/dev/null)
                while IFS= read -r cached_model; do
                    if [ -n "$cached_model" ]; then
                        cached_models+=("$cached_model")
                    fi
                done <<< "$cached_list"

                if [ ${#models[@]} -gt 0 ]; then
                    expanded_provider="$selected_item"
                    local insert_pos=$((selected_index + 1))
                    local new_items=()
                    local new_types=()
                    local new_parents=()
                    for j in "${!menu_items[@]}"; do
                        new_items+=("${menu_items[$j]}")
                        new_types+=("${menu_types[$j]}")
                        new_parents+=("${menu_parents[$j]}")
                        if [ $j -eq $selected_index ]; then
                            # Add cached models first (with star indicator)
                            if [ ${#cached_models[@]} -gt 0 ]; then
                                for cached_model in "${cached_models[@]}"; do
                                    new_items+=("â˜… $cached_model")
                                    new_types+=("model_recent")
                                    new_parents+=("$selected_item")
                                done
                            fi
                            # Add remaining models (not in cache)
                            for model in "${models[@]}"; do
                                local is_cached=false
                                if [ ${#cached_models[@]} -gt 0 ]; then
                                    for cached in "${cached_models[@]}"; do
                                        if [ "$model" == "$cached" ]; then
                                            is_cached=true
                                            break
                                        fi
                                    done
                                fi
                                if [ "$is_cached" = false ]; then
                                    new_items+=("$model")
                                    new_types+=("model")
                                    new_parents+=("$selected_item")
                                fi
                            done
                        fi
                    done
                    menu_items=("${new_items[@]}")
                    menu_types=("${new_types[@]}")
                    menu_parents=("${new_parents[@]}")
                fi
            fi
            
            printf "\033[${last_lines}A\033[J"
            draw_menu
        fi
    done

    # Show cursor after menu selection
    printf "\033[?25h"
}

# Model selection menu
show_model_menu() {
    local selected_provider_data
    local models=()
    local selected_index=0

    # Get the selected provider's data
    selected_provider_data=$(jq -c ".[] | select(.provider == \"$SELECTED_PROVIDER\")" "${SETTINGS_FILE}")
    
    if [ -z "$selected_provider_data" ] || [ "$selected_provider_data" == "null" ]; then
        printf "[1;31mError: Provider configuration not found\u001b[0m\n"
        exit 1
    fi
    
    # Extract models array (from settings or fetch dynamically)
    local base_url=$(echo "$selected_provider_data" | jq -r '.base_url')
    local auth_token=$(echo "$selected_provider_data" | jq -r '.auth_token')

    while IFS= read -r model; do
        if [ -n "$model" ]; then
            models+=("$model")
        fi
    done < <(get_models_for_provider "$SELECTED_PROVIDER" "$base_url" "$auth_token")
    
    # If only one model, use it directly
    if [ ${#models[@]} -eq 1 ]; then
        SELECTED_MODEL="${models[0]}"
        apply_provider_config
        return
    fi
    
    printf "\n[1;37mSelect Model:[0m\n"

    # Reorganize models: recent first, then rest
    local recent_models=$(jq -r ".\"${SELECTED_PROVIDER}\"[]?" "${CACHE_FILE}" 2>/dev/null)
    local reorganized_models=()

    # Add recent models first
    while IFS= read -r cached_model; do
        if [ -n "$cached_model" ]; then
            reorganized_models+=("$cached_model")
        fi
    done <<< "$recent_models"

    # Add remaining models
    for model in "${models[@]}"; do
        local found=false
        for recent in "${reorganized_models[@]}"; do
            if [ "$model" == "$recent" ]; then
                found=true
                break
            fi
        done
        if [ "$found" = false ]; then
            reorganized_models+=("$model")
        fi
    done

    # Replace models array with reorganized version
    models=("${reorganized_models[@]}")

    # Show separator if we have recent models
    if [ -n "$recent_models" ]; then
        printf "\033[38;5;246m (recent first)\033[0m"
    fi
    
    # Draw initial menu with scrolling window
    draw_model_menu() {
        local i=0
        local lines_count=0
        local max_window=10
        local window_start=0

        # Calculate window start to keep selected item visible
        if [ $selected_index -ge $max_window ]; then
            window_start=$((selected_index - max_window + 1))
        fi

        for model in "${models[@]}"; do
            # Only display models within the window
            if [ $i -ge $window_start ] && [ $lines_count -lt $max_window ]; then
                if [ $i -eq $selected_index ]; then
                    printf "\033[1;32m>\033[0m \033[1;36m%s\033[0m\n" "$model"
                else
                    printf "  \033[38;5;246m%s\033[0m\n" "$model"
                fi
                ((lines_count++))
            fi
            ((i++))
        done
    }
    
    draw_model_menu

    # Hide cursor during menu selection
    printf "\033[?25l"

    # Read arrow keys
    while IFS= read -rsn1 key; do
        if [[ $key == $'\x1b' ]]; then
            read -rsn2 key
            if [[ $key == '[A' ]]; then
                ((selected_index--))
                if [ $selected_index -lt 0 ]; then
                    selected_index=$((${#models[@]} - 1))
                fi
            elif [[ $key == '[B' ]]; then
                ((selected_index++))
                if [ $selected_index -ge ${#models[@]} ]; then
                    selected_index=0
                fi
            fi
            printf "\033[${#models[@]}A\033[J"
            draw_model_menu
        elif [[ $key == '' ]]; then
            break
        fi
    done

    # Show cursor after menu selection
    printf "\033[?25h"

    SELECTED_MODEL="${models[$selected_index]}"
    # Cache this model as recently used
    cache_recent_model "$SELECTED_PROVIDER" "$SELECTED_MODEL"
    apply_provider_config
}

# Apply provider configuration
apply_provider_config() {
    local base_url=$(echo "$selected_provider_data" | jq -r '.base_url')
    local auth_token=$(echo "$selected_provider_data" | jq -r '.auth_token')
    
    # Validate required fields
    if [ "$base_url" == "null" ] || [ "$auth_token" == "null" ]; then
        printf "[1;31mError: Provider configuration is incomplete\u001b[0m\n"
        exit 1
    fi
    
    # Create claude config with provider settings
    create_claude_config "$base_url" "$auth_token" "$SELECTED_MODEL"
    
    printf "\n[1;32mUsing provider:[0m [1;36m%s[0m ([1;33m%s[0m)\n" "$SELECTED_PROVIDER" "$SELECTED_MODEL"
}

# Show menu and get selection
show_menu

# Debug: Show what we're about to run
if [ "${DEBUG:-0}" == "1" ]; then
    echo "[DEBUG] About to execute: claude with args: '$@'" >&2
fi

# Run claude command and pass all arguments
exec claude "$@"
