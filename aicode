#!/bin/bash

set -euo pipefail

# Check if claude is installed
if ! command -v claude &> /dev/null; then
    echo "Error: claude command is not installed. Please install it first."
    echo "Visit: https://github.com/anthropics/claude-cli"
    exit 1
fi

# Paths
CONFIG_DIR="${HOME}/.config/aicode"
SETTINGS_FILE="${CONFIG_DIR}/settings.json"
CLAUDE_CONFIG_DIR="${HOME}/.claude"
CLAUDE_CONFIG_FILE="${CLAUDE_CONFIG_DIR}/settings.json"

# Create config directory if it doesn't exist
mkdir -p "${CONFIG_DIR}"
mkdir -p "${CLAUDE_CONFIG_DIR}"

# Check if settings.json exists
if [ ! -f "${SETTINGS_FILE}" ]; then
    echo "Error: Settings file not found at ${SETTINGS_FILE}"
    echo "Please create this file with your provider configurations."
    exit 1
fi

# Function to validate JSON
validate_json() {
    if ! jq empty "$1" 2>/dev/null; then
        echo "Error: Invalid JSON in $1"
        exit 1
    fi
}

validate_json "${SETTINGS_FILE}"

# Function to create claude config
create_claude_config() {
    local base_url="$1"
    local auth_token="$2"
    local model="$3"
    
    cat > "${CLAUDE_CONFIG_FILE}" << EOF
{
    "env": {
        "ANTHROPIC_BASE_URL": "${base_url}",
        "ANTHROPIC_AUTH_TOKEN": "${auth_token}",
        "ANTHROPIC_MODEL": "${model}"
    }
}
EOF
}

# Function to extract provider data
get_provider_data() {
    local provider_name="$1"
    jq -r ".[] | select(.provider == \"${provider_name}\") | \"\(.base_url)|\(.auth_token)|\(.model)\"" "${SETTINGS_FILE}"
}

# Display menu and get selection with interactive UI
show_menu() {
    local providers_array=()
    local options=()
    
    # Add Claude as first option
    options+=("claude")
    
    # Parse providers from settings.json
    while IFS= read -r line; do
        if [ -n "$line" ]; then
            providers_array+=("$line")
            local provider_name=$(echo "$line" | jq -r '.provider')
            options+=("$provider_name")
        fi
    done < <(jq -c '.[]' "${SETTINGS_FILE}")
    
    # Show provider selection menu
    show_provider_menu
    return
}

# Hierarchical provider/model selection menu
show_provider_menu() {
    local providers_array=()
    local menu_items=()
    local menu_types=()
    local menu_parents=()
    local selected_index=0
    local expanded_provider=""
    
    # Add Claude as first option
    menu_items+=("claude")
    menu_types+=("provider")
    menu_parents+=("")
    
    # Parse providers from settings.json
    while IFS= read -r line; do
        if [ -n "$line" ]; then
            providers_array+=("$line")
            local provider_name=$(echo "$line" | jq -r '.provider')
            menu_items+=("$provider_name")
            menu_types+=("provider")
            menu_parents+=("")
        fi
    done < <(jq -c '.[]' "${SETTINGS_FILE}")
    
    printf "[1;37mSelect AI Provider and Model:[0m\n"
    
    local last_lines=0
    
    # Draw menu
    draw_menu() {
        local i=0
        local display_index=0
        local lines_count=0
        for item in "${menu_items[@]}"; do
            local item_type="${menu_types[$i]}"
            local item_parent="${menu_parents[$i]}"
            
            if [ $display_index -eq $selected_index ]; then
                if [ "$item_parent" == "" ]; then
                    printf "[1;32m>[0m [1;36m%s[0m\n" "$item"
                else
                    printf "[1;32m>[0m   [1;33m%-s[0m\n" "$item"
                fi
            else
                if [ "$item_parent" == "" ]; then
                    printf "  [38;5;246m%s[0m\n" "$item"
                else
                    printf "    [38;5;246mâ”œâ”€ %s[0m\n" "$item"
                fi
            fi
            ((lines_count++))
            ((display_index++))
            ((i++))
        done
        last_lines=$lines_count
    }
    
    draw_menu
    
    # Read arrow keys and Enter
    while IFS= read -rsn1 key; do
        if [[ $key == $'\x1b' ]]; then
            read -rsn2 key
            if [[ $key == '[A' ]]; then
                ((selected_index--))
                if [ $selected_index -lt 0 ]; then
                    selected_index=$((${#menu_items[@]} - 1))
                fi
                printf "[${last_lines}A[J"
                draw_menu
            elif [[ $key == '[B' ]]; then
                ((selected_index++))
                if [ $selected_index -ge ${#menu_items[@]} ]; then
                    selected_index=0
                fi
                printf "[${last_lines}A[J"
                draw_menu
            fi
        elif [[ $key == '' ]]; then
            # Enter key pressed
            local selected_item="${menu_items[$selected_index]}"
            local selected_type="${menu_types[$selected_index]}"
            local selected_parent="${menu_parents[$selected_index]}"
            
            # If selecting a model (has parent)
            if [ "$selected_parent" != "" ]; then
                SELECTED_PROVIDER="$selected_parent"
                SELECTED_MODEL="$selected_item"
                selected_provider_data=$(jq -c ".[] | select(.provider == \"$SELECTED_PROVIDER\")" "${SETTINGS_FILE}")
                apply_provider_config
                break
            fi
            
            # If selecting Claude
            if [ "$selected_item" == "claude" ]; then
                if [ -f "${CLAUDE_CONFIG_FILE}" ]; then
                    rm "${CLAUDE_CONFIG_FILE}"
                fi
                unset ANTHROPIC_BASE_URL ANTHROPIC_AUTH_TOKEN ANTHROPIC_MODEL 2>/dev/null
                echo -e "\n\033[1;32mUsing provider:\033[0m \033[1;36m${selected_item}\033[0m"
                echo -e "\033[38;5;246mInitializing Claude (this may take a moment)...\033[0m"
                break
            fi
            
            # If provider is already expanded, collapse it
            if [ "$expanded_provider" == "$selected_item" ]; then
                expanded_provider=""
                # Remove models from menu
                local new_items=()
                local new_types=()
                local new_parents=()
                for j in "${!menu_items[@]}"; do
                    if [ "${menu_parents[$j]}" != "$selected_item" ]; then
                        new_items+=("${menu_items[$j]}")
                        new_types+=("${menu_types[$j]}")
                        new_parents+=("${menu_parents[$j]}")
                    fi
                done
                menu_items=("${new_items[@]}")
                menu_types=("${new_types[@]}")
                menu_parents=("${new_parents[@]}")
                if [ $selected_index -ge ${#menu_items[@]} ]; then
                    selected_index=$((${#menu_items[@]} - 1))
                fi
            else
                # Expand provider - add models
                local provider_data=$(jq -c ".[] | select(.provider == \"$selected_item\")" "${SETTINGS_FILE}")
                local models=()
                while IFS= read -r model; do
                    if [ -n "$model" ]; then
                        models+=("$model")
                    fi
                done < <(echo "$provider_data" | jq -r '.models[]')
                
                if [ ${#models[@]} -gt 0 ]; then
                    expanded_provider="$selected_item"
                    local insert_pos=$((selected_index + 1))
                    local new_items=()
                    local new_types=()
                    local new_parents=()
                    for j in "${!menu_items[@]}"; do
                        new_items+=("${menu_items[$j]}")
                        new_types+=("${menu_types[$j]}")
                        new_parents+=("${menu_parents[$j]}")
                        if [ $j -eq $selected_index ]; then
                            for model in "${models[@]}"; do
                                new_items+=("$model")
                                new_types+=("model")
                                new_parents+=("$selected_item")
                            done
                        fi
                    done
                    menu_items=("${new_items[@]}")
                    menu_types=("${new_types[@]}")
                    menu_parents=("${new_parents[@]}")
                fi
            fi
            
            printf "[${last_lines}A[J"
            draw_menu
        fi
    done
}

# Model selection menu
show_model_menu() {
    local selected_provider_data
    local models=()
    local selected_index=0
    
    # Get the selected provider's data
    selected_provider_data=$(jq -c ".[] | select(.provider == \"$SELECTED_PROVIDER\")" "${SETTINGS_FILE}")
    
    if [ -z "$selected_provider_data" ] || [ "$selected_provider_data" == "null" ]; then
        printf "[1;31mError: Provider configuration not found\u001b[0m\n"
        exit 1
    fi
    
    # Extract models array
    while IFS= read -r model; do
        if [ -n "$model" ]; then
            models+=("$model")
        fi
    done < <(echo "$selected_provider_data" | jq -r '.models[]')
    
    # If only one model, use it directly
    if [ ${#models[@]} -eq 1 ]; then
        SELECTED_MODEL="${models[0]}"
        apply_provider_config
        return
    fi
    
    printf "\n[1;37mSelect Model:[0m\n"
    
    # Draw initial menu
    draw_model_menu() {
        local i=0
        for model in "${models[@]}"; do
            if [ $i -eq $selected_index ]; then
                printf "[1;32m>[0m [1;36m%s[0m\n" "$model"
            else
                printf "  [38;5;246m%s[0m\n" "$model"
            fi
            ((i++))
        done
    }
    
    draw_model_menu
    
    # Read arrow keys
    while IFS= read -rsn1 key; do
        if [[ $key == $'\x1b' ]]; then
            read -rsn2 key
            if [[ $key == '[A' ]]; then
                ((selected_index--))
                if [ $selected_index -lt 0 ]; then
                    selected_index=$((${#models[@]} - 1))
                fi
            elif [[ $key == '[B' ]]; then
                ((selected_index++))
                if [ $selected_index -ge ${#models[@]} ]; then
                    selected_index=0
                fi
            fi
            printf "[${#models[@]}A[J"
            draw_model_menu
        elif [[ $key == '' ]]; then
            break
        fi
    done
    
    SELECTED_MODEL="${models[$selected_index]}"
    apply_provider_config
}

# Apply provider configuration
apply_provider_config() {
    local base_url=$(echo "$selected_provider_data" | jq -r '.base_url')
    local auth_token=$(echo "$selected_provider_data" | jq -r '.auth_token')
    
    # Validate required fields
    if [ "$base_url" == "null" ] || [ "$auth_token" == "null" ]; then
        printf "[1;31mError: Provider configuration is incomplete\u001b[0m\n"
        exit 1
    fi
    
    # Create claude config with provider settings
    create_claude_config "$base_url" "$auth_token" "$SELECTED_MODEL"
    
    printf "\n[1;32mUsing provider:[0m [1;36m%s[0m ([1;33m%s[0m)\n" "$SELECTED_PROVIDER" "$SELECTED_MODEL"
}

# Show menu and get selection
show_menu

# Debug: Show what we're about to run
if [ "${DEBUG:-0}" == "1" ]; then
    echo "[DEBUG] About to execute: claude with args: '$@'" >&2
fi

# Run claude command and pass all arguments
exec claude "$@"
